#!/usr/bin/env ruby

require 'rokkin'
require 'thor'
require 'git'

class RokkinCLI < Thor
  desc "clone URL", "This will clone the git repo located at URL into the current directory"
  option :sha
  option :path
  def clone(url)
    repo_name = url.split('/')[-1].chomp(".git")
    full_path = File.expand_path(options[:path] || repo_name)

    print "Cloning into #{full_path} ... "
    begin
      repo = Git.clone(url, full_path)
    rescue Git::GitExecuteError => e
      puts "error!"
      raise e
    end
    puts "done"

    if options[:sha]
      print "Checking out #{options[:sha]} ... "
      begin
        repo.checkout(options[:sha])
        puts "done"
      rescue Git::GitExecuteError => e
        puts "error!"
        puts e
      end
    end

    containerize(full_path)
  end

  desc "containerize PATH", "This will containerize the ruby app located at PATH. Default is the current directory"
  def containerize(path='.')
    full_path = File.expand_path(path)

    print "Containerizing #{full_path} ... "
    Rokkin.containerize(full_path)
    puts "done"
  end
end

RokkinCLI.start(ARGV)
